---
title: "Elecciones: una librería en R para descargar resultados electorales"
subtitle: "Ejemplo de uso"
author: "Héctor Meleiro"
date: "24/01/2018"
output:
  html_document:
    keep_md: yes
    highlight: tango
    theme: united
    toc: yes
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: united
    toc: yes
  word_document:
    toc: yes
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, results = T, include = T, warning = F, message = F, tidy = T)
```


# Cargar las librerías

```{r}
# Cargo las librerías
library(sf)
library(tidyverse)
library(mapdeck)
library(knitr)
library(kableExtra)

#devtools::install_github("meneos/elecciones") # <--- Instala la librería elecciones

library(elecciones)

```

# Importar el shapefile
Empezamos importanto el shapefile de la Comunidad de Madrid y selecciono solo la ciudad de Madrid.

```{r}

shp <- read_sf("~/Google Drive/DATOS/R/COMPORTAMIENTO ELECTORAL/shp/Comunidad de Madrid/2015/corregido/secciones_corregidas.shp", quiet = T) ### Importo el shapefile 
shp <- shp[substr(shp$GEOCODIGO, 1, 3) == "079",]  # Selecciono solo la ciudad de Madrid
shp <-  st_transform(shp, 4326)  # Transformo la proyección
```

# Descargar los resultados

Me descargo los resultados a nivel de mesa de las elecciones municipales de mayo de 2015 y me quedo solo con los de la ciudad de Madrid.

```{r}

results.muni <- mesas("municipales", "2015", "05") # Descargo los datos

results.muni <- results.muni[results.muni$provincia == "28" & results.muni$municipio == "079",] # 28 = Comunidad de Madrid | 079 = Ciudad de Madrid


ktab <- kable(head(results.muni), digits = 4, align = "l", row.names = F)
kable_styling(ktab, bootstrap_options = c("striped", "hover")) %>% scroll_box(width = "100%", height = "200px")

```

# Agrupar las mesas en secciones

Los datos se descargan a nivel de mesa electoral pero yo los quiero a nivel de sección censal. Así que agrupo los datos y me quedo solo con los cinco partidos más votados.

```{r}

# Agrupo los datos
seccs.muni <- results.muni %>% 
  group_by(year, mes, municipio, distrito, seccion, siglas) %>% 
  summarise(censo = sum(censo.INE), 
            votos.candidatura = sum(candidaturas), 
            votos = sum(votos))

# Selecciono a los cinco partidos
seccs.muni <- seccs.muni[seccs.muni$siglas %in% c("P.P.", "C's", "AhoraMadrid", "P.S.O.E.", "IZQUIERDA U"),]

# Transformo los datos de formato long a wide 
seccs.muni <- spread(seccs.muni, key = siglas, value = votos)

# Calculo los % sobre censo
seccs.muni$PP_pct <- round((seccs.muni$P.P. / seccs.muni$censo ) * 100, 2)
seccs.muni$PSOE_pct <- round(( seccs.muni$P.S.O.E. / seccs.muni$censo ) * 100, 2)
seccs.muni$AM_pct <- round(( seccs.muni$AhoraMadrid / seccs.muni$censo ) * 100, 2)
seccs.muni$Cs_pct <- round(( seccs.muni$`C's` / seccs.muni$censo ) * 100, 2)


ktab <- kable(head(seccs.muni), digits = 4, align = "l", row.names = F)
kable_styling(ktab, bootstrap_options = c("striped", "hover")) %>% scroll_box(width = "100%", height = "200px")

```

# Fusiono los datos con el shapefile

Creo una columna en el data frame de los datos con valores identificadores de cada seccion censal que ya está presente en el shapefile para fusionar datos y shapefile.
```{r}

seccs.muni$GEOCODIGO <- paste0(seccs.muni$municipio, seccs.muni$distrito, seccs.muni$seccion)

shp <- merge(shp, seccs.muni, by = "GEOCODIGO")

```

# Visualizamos

Uso la librería [mapdeck](https://github.com/SymbolixAU/mapdeck) para visualizar un mapa del voto a Ahora Madrid.

```{r}

# Introducir el token de Mapbox
tkn <- readLines("~/Google Drive/DATOS/R/MAPAS MAS MADRID/token.txt")

# Para el panel hover
shp$info <- paste0("<br><b> Sobre censo</br></b>",
                         "<br><b>", "PP: ", "</b>", shp$PP_pct, " %", "</br>",
                         "<br><b>", "Ahora Madrid: ", "</b>" ,shp$AM_pct, " %", "</br>",
                         "<br><b>", "PSOE: ", "</b>" ,shp$PSOE_pct, " %", "</br>",
                         "<br><b>", "Ciudadanos: ", "</b>" ,shp$Cs_pct, " %", "</br>")


# Rampa de colores
m <- grDevices::colorRamp(c("#e1f7f2", "#26a58e"))( (1:256)/256 )


mapdeck(token = tkn, 
        width = 1600/2, 
        height = 900/2, 
        style = mapdeck_style(style = "light"), 
        location = c(-3.71133, 40.42244),
        zoom = 9) %>%
  add_polygon(data = shp,
              layer_id = "AM", 
              fill_colour = "AM_pct", palette = m, 
              tooltip = "info", 
              fill_opacity = 200, legend = T, 
              update_view = F,
              legend_options = list(title = "Ahora Madrid",
                                    subtitle = "Sobre censo",
                                    css = "font-family: Roboto Condensed"))

```

# O lo guardamos

También podemos guardar el shapefile para abrirlo con alguna aplicación GIS. En este caso lo guardo como un [Geopackage](https://www.geopackage.org/).
```{r}
sf::write_sf(shp, "~/Google Drive/DATOS/R/MAPAS MAS MADRID/GPKG/elecciones24M.gpkg", driver = "GPKG")
```


